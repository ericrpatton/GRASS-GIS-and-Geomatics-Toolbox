#! /bin/sh
#
############################################################################
#
# MODULE:        r.in.geotiff
# 
# AUTHOR(S):   	 Eric Patton 
# 
# PURPOSE:       This script imports a tiff using r.in.gdal and patches the 
#		 output r,g,b rasters into a final rbg raster map.
#
# COPYRIGHT:     (C) 2006 by the GRASS Development Team
#
#                This program is free software under the GNU General Public
#                License (>=v2). Read the file COPYING that comes with GRASS
#                for details.
#
# Last Modified: February 13, 2006 
#
#############################################################################

#%Module
#% description: Imports tiffs and geotiffs completely, including the r.composite step.
#%END

#%flag
#% key: d
#% description: dither colors during rgb merge 
#%END

#%option
#% key: input
#% type: string
#% gisprompt: cell,fcell
#% description: input image
#% required : yes
#%END

#%option
#% key: output
#% type: string
#% gisprompt: cell,fcell
#% description: output raster
#% required : no
#%END


if  [ -z "$GISBASE" ] ; then
    echo "You must be in GRASS GIS to run this program." >&2
    exit 1
fi

if [ "$1" != "@ARGS_PARSED@" ] ; then
	exec g.parser "$0" "$@"
fi

# Trap Ctrl-C for clean exiting
trap 'echo "" ; echo "Ctrl-C or similar caught; exiting..." ; echo "" ; exit 1' 2 3 15


INPUT="$GIS_OPT_input"
OUTPUT="$GIS_OPT_output"


# Check parameters
if [ -z "$INPUT" ] ; then
	echo ""
	echo "$SCRIPT: Error: You must enter an input raster." >&2
fi

if [ -z "$OUTPUT" ] ; then
	echo ""
	echo "No output file given. Setting output raster to $INPUT."
	OUTPUT=$INPUT
fi	

VERSION=`g.version | cut -d' ' -f2`
echo "Using Grass version $VERSION..."


# Import routine for Grass 6.1 and up
if [ "$VERSION" = "6.1.cvs" ] ; then
	echo ""
	echo "Importing image $INPUT..."
	echo ""
	r.in.gdal input=$INPUT output=$OUTPUT
		
	# Dither output if -d flag is set.
	if [ "$GIS_FLAG_d" -eq 1 ] ; then
		r.composite -d r=$OUTPUT.r g=$OUTPUT.g b=$OUTPUT.b output=$OUTPUT output=$OUTPUT
	else
		r.composite r=$OUTPUT.r g=$OUTPUT.g b=$OUTPUT.b output=$OUTPUT output=$OUTPUT
	fi	
	
	if [ "$?" -eq 0 ] ; then
		echo ""
		echo "Done!"
	else
		echo ""
		echo "An error occurred during import. Exiting."
		echo ""
        fi

else    # Routine to use for Grass 6.0.x 
	echo ""
	echo "Importing image $INPUT..."
	echo ""
	r.in.gdal input=$INPUT output=$OUTPUT
	
	# Dither output if -d flag is set.
	if [ "$GIS_FLAG_d" -eq 1 ] ; then
		r.composite -d red=$OUTPUT.red green=$OUTPUT.green blue=$OUTPUT.blue output=$OUTPUT
	else
		r.composite red=$OUTPUT.red green=$OUTPUT.green blue=$OUTPUT.blue output=$OUTPUT
	fi
	
	if [ "$?" -eq 0 ] ; then
		echo ""
		echo "Done!"
	else
		echo ""
		echo "An error occurred during import. Exiting."
		echo ""

	fi
fi

# Cleanup
if [ "$VERSION" = "6.0.?" ] ; then
	g.remove rast=$OUTPUT.red,$OUTPUT.green,$OUTPUT.blue
else
	g.remove rast=$OUTPUT.r,$OUTPUT.g,$OUTPUT.b
fi

exit 0
	


	




















#! /bin/sh
#
#
# A script to Convert UNB-format r4 multibeam bathymetry files into space-delimited XYZ ascii.
#

if  [ -z "$GISBASE" ] ; then
    echo "You must be in GRASS GIS to run this program."
    exit 1
fi

trap 'echo "User break! Exiting..." ; rm -r TMP* ; exit 1' 2 3 15

echo -e -n "\nEnter r4 search pattern: "
read PATTERN

echo -e -n "\nEnter utm zone required: "
read ZONE

while [ -z "$PATTERN" ] ; do

	echo -e "\n$SCRIPT: Error: No raster input received!"
	echo -n "Please enter a raster search pattern: "
	read PATTERN

done

while [ -z "$ZONE" ] ; do

	echo -e "\n$SCRIPT: Error: No UTM Zone received!"
	echo -n "Please enter a UTM zone for projection: "
	read ZONE

done


echo -e "\n\nSet to process $MAP in WGS84 datum, UTM Zone $ZONE projection."
sleep 2

# Check if we have awk.
if [ ! -x "`which awk`" ] ; then
    echo "$SCRIPT: awk required, please install awk or gawk first" 2>&1
	exit 1
fi

# Check if we have proj.
if [ ! -x "`which proj`" ] ; then
    echo "$SCRIPT: proj4 required, please install proj first" 2>&1
	exit 1
fi

# NOTE: This script needs to be run in the same directory the r4 files are located in!

for MAP in `ls $PATTERN` ; do 


	echo -e "\nRunning r4toASCII on $MAP...\n\n"
	
	r4toASCII ${MAP} TMP1

	if [ $? -ne 0 ] ; then
		echo -e "\nr4toASCII was unsuccessful. Exiting."
		exit 1
	else
		echo -e "\n\nFinished r4toASCII conversion..."
		echo -e "Beginning formatting and UTM projection...\n"
	fi

	awk '{print $1, $2, $3*(-1)}' TMP1 | proj -r +proj=utm +ellps=WGS84 +zone=$ZONE | awk '{print $1, $2, $3}' > $MAP.utm

	if [ $? -ne 0 ] ; then
		echo -e "\n\nFormatting failed. Exiting."
		exit 1
	else
		echo -e "\nFinished exporting $MAP to $MAP.utm."
		echo -e "Cleaning up temp files..."
		rm -f TMP*
		echo -e "\nDone."
	fi
done

exit 0





